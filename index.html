
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broker Forex - Simulasi Trading</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .price-up { color: #22c55e; } /* green-500 */
        .price-down { color: #ef4444; } /* red-500 */
        .price-stale { color: #64748b; } /* slate-500 */
        .market-pair:hover { background-color: #334155; } /* slate-700 */
        .market-pair.active { background-color: #4f46e5; } /* indigo-600 */
        .tab-btn {
            border-color: transparent;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            border-color: #4f46e5; /* indigo-600 */
            color: #ffffff;
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        /* Toast Notification */
        #toast-notification {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        #toast-notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        /* Tooltip & Glossary */
        .has-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .has-tooltip:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            width: 220px;
            background-color: #334155; /* slate-700 */
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.25;
        }
        .tooltip-icon {
            cursor: help;
            margin-left: 6px;
            color: #94a3b8; /* slate-400 */
        }
        
        /* Interactive Tutorial */
        #tutorial-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.8);
            z-index: 9998;
        }
        .tutorial-highlight {
            position: relative;
            z-index: 9999;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.8);
            border-radius: 8px;
        }
        #tutorial-box {
            position: absolute;
            z-index: 10000;
            background-color: #1e293b; /* slate-800 */
            padding: 20px;
            border-radius: 12px;
            width: 320px;
            border: 1px solid #334155; /* slate-700 */
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">

        <!-- Auth Screen -->
        <div id="auth-screen" class="w-full max-w-md">
            <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-white">Simulasi Trading</h1>
                    <p class="text-slate-400">Masuk atau Daftar untuk memulai</p>
                </div>
                <form id="auth-form" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-slate-300">Email</label>
                        <input type="email" id="email" required class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-slate-300">Password</label>
                        <input type="password" id="password" required class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex items-center justify-between pt-2 space-x-4">
                        <button type="button" id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Masuk</button>
                        <button type="button" id="register-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Daftar</button>
                    </div>
                </form>
                <p id="auth-error" class="text-red-500 text-sm mt-4 text-center"></p>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboard-screen" class="hidden w-full max-w-7xl mx-auto">
            <header id="main-header" class="flex justify-between items-center mb-6 p-4 bg-slate-800 rounded-2xl shadow-lg">
                <div>
                    <h1 class="text-2xl font-bold text-white">Dashboard Trading</h1>
                    <p id="user-email" class="text-sm text-slate-400"></p>
                </div>
                <div class="text-right">
                    <p class="text-slate-400 text-sm">Saldo Akun</p>
                    <p id="account-balance" class="text-xl font-semibold text-green-400">$0.00</p>
                </div>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Keluar</button>
            </header>

            <!-- Analytics & Achievements -->
            <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div id="analytics-panel" class="md:col-span-2 bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 text-white">Analisis Kinerja</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-slate-700/50 p-4 rounded-lg text-center">
                            <p class="text-sm text-slate-400">Total Trades</p>
                            <h3 id="analytics-total-trades" class="text-2xl font-bold text-white">-</h3>
                        </div>
                        <div class="bg-slate-700/50 p-4 rounded-lg text-center">
                             <div class="has-tooltip justify-center">
                                <p class="text-sm text-slate-400">Win Rate</p>
                                <span class="tooltip-icon">(?)
                                    <span class="tooltip">Persentase dari total trade yang menghasilkan profit.</span>
                                </span>
                            </div>
                            <h3 id="analytics-win-rate" class="text-2xl font-bold text-white">-</h3>
                        </div>
                        <div class="bg-slate-700/50 p-4 rounded-lg text-center">
                            <div class="has-tooltip justify-center">
                                <p class="text-sm text-slate-400">Total P/L</p>
                                <span class="tooltip-icon">(?)
                                    <span class="tooltip">Total Profit atau Loss (kerugian) dari semua trade yang sudah ditutup.</span>
                                </span>
                            </div>
                            <h3 id="analytics-total-pl" class="text-2xl font-bold text-white">-</h3>
                        </div>
                        <div class="bg-slate-700/50 p-4 rounded-lg text-center">
                            <p class="text-sm text-slate-400">Rata-rata P/L</p>
                            <h3 id="analytics-avg-pl" class="text-2xl font-bold text-white">-</h3>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 text-white">Pencapaian</h2>
                    <div id="achievements-container" class="flex justify-center items-center space-x-4 h-full">
                        <!-- Achievements will be rendered here -->
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 flex flex-col gap-6">
                    <div id="market-panel" class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4 border-b border-slate-700 pb-2">Pasar</h2>
                        <div id="market-watch" class="space-y-3"></div>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4 border-b border-slate-700 pb-2">Papan Peringkat</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-400 uppercase">
                                    <tr>
                                        <th class="py-2 px-2">#</th>
                                        <th class="py-2 px-2">Trader</th>
                                        <th class="py-2 px-2 text-right">Saldo</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboard-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div id="trading-panel" class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4 border-b border-slate-700 pb-2">Panel Trading</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                           <div class="md:col-span-1">
                                <label for="pair-select" class="block text-sm font-medium text-slate-300">Aset</label>
                                <select id="pair-select" class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
                            </div>
                             <div class="md:col-span-1">
                                <label for="order-type" class="block text-sm font-medium text-slate-300">Tipe Order</label>
                                <select id="order-type" class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="market">Market Execution</option>
                                    <option value="buy_limit">Buy Limit</option>
                                    <option value="sell_limit">Sell Limit</option>
                                    <option value="buy_stop">Buy Stop</option>
                                    <option value="sell_stop">Sell Stop</option>
                                </select>
                            </div>
                             <div id="entry-price-container" class="md:col-span-1 hidden">
                                <label for="entry-price" class="block text-sm font-medium text-slate-300">Harga Entri</label>
                                <input type="number" id="entry-price" placeholder="Harga" step="0.0001" class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                             <div class="md:col-span-1">
                                <label for="trade-size" class="block text-sm font-medium text-slate-300 has-tooltip">Ukuran (Lot)
                                    <span class="tooltip-icon">(?)
                                        <span class="tooltip">Lot adalah satuan ukuran transaksi. 1.00 lot standar bernilai 100.000 unit mata uang dasar.</span>
                                    </span>
                                </label>
                                <input type="number" id="trade-size" value="0.01" step="0.01" min="0.01" class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                             <div class="md:col-span-1">
                                <label for="stop-loss" class="block text-sm font-medium text-slate-300 has-tooltip">Stop Loss
                                    <span class="tooltip-icon">(?)
                                        <span class="tooltip">Level harga untuk menutup posisi secara otomatis guna membatasi kerugian.</span>
                                    </span>
                                </label>
                                <input type="number" id="stop-loss" placeholder="Harga" step="0.0001" class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                             <div class="md:col-span-1">
                                <label for="take-profit" class="block text-sm font-medium text-slate-300 has-tooltip">Take Profit
                                    <span class="tooltip-icon">(?)
                                        <span class="tooltip">Level harga untuk menutup posisi secara otomatis guna mengamankan keuntungan.</span>
                                    </span>
                                </label>
                                <input type="number" id="take-profit" placeholder="Harga" step="0.0001" class="mt-1 block w-full bg-slate-700 border border-slate-600 rounded-lg shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                             <button id="place-order-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Place Order</button>
                        </div>
                        <p id="trade-message" class="text-sm mt-4 text-center"></p>
                    </div>

                    <div id="chart-panel" class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                        <h2 id="chart-title" class="text-xl font-bold mb-4 border-b border-slate-700 pb-2">Grafik Harga: EUR/USD</h2>
                        <div id="chart-container" class="h-96 w-full h-full relative">
                            <!-- TradingView Chart will be injected here -->
                        </div>
                    </div>

                    <div id="positions-panel" class="bg-slate-800 p-6 rounded-2xl shadow-lg">
                        <div class="border-b border-slate-700 mb-4">
                            <nav class="-mb-px flex space-x-6">
                                <button id="open-positions-tab" class="tab-btn active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-slate-400">Posisi Terbuka</button>
                                <button id="pending-orders-tab" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-slate-400">Order Tertunda</button>
                                <button id="history-tab" class="tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-slate-400">Riwayat Trading</button>
                            </nav>
                        </div>
                        
                        <div id="open-positions-view">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs text-slate-400 uppercase bg-slate-700/50">
                                        <tr>
                                            <th scope="col" class="px-4 py-3">Detail</th>
                                            <th scope="col" class="px-4 py-3">Harga Buka</th>
                                            <th scope="col" class="px-4 py-3">SL/TP</th>
                                            <th scope="col" class="px-4 py-3 has-tooltip">P/L
                                                <span class="tooltip-icon">(?)
                                                    <span class="tooltip">Profit/Loss yang belum direalisasi untuk posisi yang sedang berjalan.</span>
                                                </span>
                                            </th>
                                            <th scope="col" class="px-4 py-3">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="positions-table"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="pending-orders-view" class="hidden">
                             <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs text-slate-400 uppercase bg-slate-700/50">
                                        <tr>
                                            <th scope="col" class="px-4 py-3">Detail</th>
                                            <th scope="col" class="px-4 py-3">Harga Entri</th>
                                            <th scope="col" class="px-4 py-3">SL/TP</th>
                                            <th scope="col" class="px-4 py-3">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pending-orders-table"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="history-view" class="hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs text-slate-400 uppercase bg-slate-700/50">
                                        <tr>
                                            <th scope="col" class="px-4 py-3">Detail</th>
                                            <th scope="col" class="px-4 py-3">Harga Buka/Tutup</th>
                                            <th scope="col" class="px-4 py-3">Waktu Tutup</th>
                                            <th scope="col" class="px-4 py-3">P/L</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="text-center mt-8 text-slate-500 text-xs">
                <p>DISCLAIMER: Ini adalah aplikasi simulasi trading. JANGAN gunakan untuk trading dengan uang sungguhan. Harga yang ditampilkan adalah simulasi dan tidak akurat.</p>
                <p>User ID Anda (untuk kolaborasi): <span id="user-id-display" class="font-mono"></span></p>
            </footer>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-lg font-bold text-white mb-2">Konfirmasi Tindakan</h3>
            <p id="modal-message" class="text-slate-300 mb-6">Apakah Anda yakin?</p>
            <div class="flex justify-center space-x-4">
                <button id="modal-cancel-btn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Batal</button>
                <button id="modal-confirm-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Konfirmasi</button>
            </div>
        </div>
    </div>
    
    <!-- Tutorial -->
    <div id="tutorial-overlay" class="hidden">
        <div id="tutorial-box">
            <h3 id="tutorial-title" class="text-lg font-bold text-white mb-2"></h3>
            <p id="tutorial-text" class="text-slate-300 mb-6 text-sm"></p>
            <div class="flex justify-between items-center">
                <span id="tutorial-step" class="text-xs text-slate-400"></span>
                <div class="space-x-2">
                    <button id="tutorial-skip-btn" class="bg-slate-600 hover:bg-slate-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition">Lewati</button>
                    <button id="tutorial-next-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-lg text-sm transition">Lanjut</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg">
        <p id="toast-message"></p>
    </div>


    <script type="module">
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyC6Es1HpmWqmNSaACoKG2wYPq_dBkyFYSs",
            authDomain: "database-forex.firebaseapp.com",
            projectId: "database-forex",
            storageBucket: "database-forex.appspot.com",
            messagingSenderId: "780234110549",
            appId: "1:780234110549:web:b72051f7e28ea2ec3506dc",
            measurementId: "G-LWKQTY831W"
        };
        
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, onSnapshot, updateDoc, serverTimestamp, writeBatch, orderBy, limit, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global Variables & Definitions ---
        const ASSETS = ['EUR/USD', 'GBP/USD', 'USD/JPY', 'AUD/USD', 'USD/CAD', 'XAU/USD', 'BTC/USD'];
        const ACHIEVEMENT_DEFINITIONS = {
            'first_trade': { name: 'Trader Pemula', description: 'Melakukan trade pertama Anda.', icon: '🚀' },
            'first_profit': { name: 'Cuan Perdana', description: 'Mendapatkan profit pertama.', icon: '💰' },
            'profit_streak_3': { name: 'Lagi Hoki', description: 'Profit 3 kali berturut-turut.', icon: '🔥' },
            'balance_12k': { name: 'Naik Kelas', description: 'Mencapai saldo $12,000.', icon: '📈' },
            'balance_15k': { name: 'Sultan', description: 'Mencapai saldo $15,000.', icon: '👑' },
        };
        const TUTORIAL_STEPS = [
            { selector: '#market-panel', title: 'Panel Pasar', text: 'Di sini Anda dapat melihat harga aset secara real-time. Klik pada salah satu aset untuk melihat grafiknya.' },
            { selector: '#chart-panel', title: 'Grafik Harga', text: 'Grafik ini menunjukkan pergerakan harga historis dari aset yang Anda pilih.' },
            { selector: '#trading-panel', title: 'Panel Trading', text: 'Gunakan panel ini untuk menempatkan order baru, baik itu eksekusi pasar langsung maupun order tertunda.' },
            { selector: '#positions-panel', title: 'Manajemen Posisi', text: 'Lihat posisi yang sedang berjalan, order tertunda, dan riwayat trading Anda di sini. Selamat mencoba!' },
        ];
        let currentTutorialStep = 0;

        let currentPrices = {};
        let priceInterval;
        let positionsUnsubscribe = null;
        let pendingOrdersUnsubscribe = null;
        let historyUnsubscribe = null;
        let leaderboardUnsubscribe = null;
        let userDocUnsubscribe = null;
        let chart = null;
        let candlestickSeries = null;
        let historicalData = {};
        let activeChartPair = 'EUR/USD';
        let openPositions = []; 
        let pendingOrders = [];
        let chartResizeObserver = null;

        // --- UI Elements ---
        const authScreen = document.getElementById('auth-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const userEmailDisplay = document.getElementById('user-email');
        const userIdDisplay = document.getElementById('user-id-display');
        const accountBalanceDisplay = document.getElementById('account-balance');
        const marketWatch = document.getElementById('market-watch');
        const pairSelect = document.getElementById('pair-select');
        const positionsTable = document.getElementById('positions-table');
        const pendingOrdersTable = document.getElementById('pending-orders-table');
        const historyTable = document.getElementById('history-table');
        const chartContainer = document.getElementById('chart-container');
        const chartTitle = document.getElementById('chart-title');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const openPositionsTab = document.getElementById('open-positions-tab');
        const pendingOrdersTab = document.getElementById('pending-orders-tab');
        const historyTab = document.getElementById('history-tab');
        const openPositionsView = document.getElementById('open-positions-view');
        const pendingOrdersView = document.getElementById('pending-orders-view');
        const historyView = document.getElementById('history-view');
        const analyticsTotalTrades = document.getElementById('analytics-total-trades');
        const analyticsWinRate = document.getElementById('analytics-win-rate');
        const analyticsTotalPl = document.getElementById('analytics-total-pl');
        const analyticsAvgPl = document.getElementById('analytics-avg-pl');
        const leaderboardTable = document.getElementById('leaderboard-table');
        const achievementsContainer = document.getElementById('achievements-container');
        const toastNotification = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        const orderTypeSelect = document.getElementById('order-type');
        const entryPriceContainer = document.getElementById('entry-price-container');
        const entryPriceInput = document.getElementById('entry-price');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const tutorialOverlay = document.getElementById('tutorial-overlay');
        const tutorialBox = document.getElementById('tutorial-box');

        // --- Initial Setup ---
        populatePairSelect();
        
        // --- Authentication ---
        onAuthStateChanged(auth, async user => {
            if (user) {
                authScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
                userEmailDisplay.textContent = user.email;
                userIdDisplay.textContent = user.uid;
                
                initDashboard(user.uid);
                
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists() && !userDoc.data().hasCompletedTutorial) {
                    startTutorial();
                }
            } else {
                authScreen.classList.remove('hidden');
                dashboardScreen.classList.add('hidden');
                cleanupDashboard();
            }
        });

        async function initializeUserProfile(userId, email) {
            const userDocRef = doc(db, 'users', userId);
            await setDoc(userDocRef, {
                email: email, 
                balance: 10000, 
                createdAt: serverTimestamp(), 
                achievements: [],
                hasCompletedTutorial: false
            });
            const leaderboardDocRef = doc(db, 'leaderboard', userId);
            await setDoc(leaderboardDocRef, {
                email: email, balance: 10000
            });
        }
        
        // --- Dashboard Initialization & Cleanup ---
        function initDashboard(userId) {
            listenToUserDocument(userId);
            listenToPositions(userId);
            listenToPendingOrders(userId);
            listenToHistory(userId);
            listenToLeaderboard();
            
            listenToMarketData();
            
            // More robust chart initialization
            setupChart();
        }

        function cleanupDashboard() {
            if (priceInterval) clearInterval(priceInterval);
            if (positionsUnsubscribe) positionsUnsubscribe();
            if (pendingOrdersUnsubscribe) pendingOrdersUnsubscribe();
            if (historyUnsubscribe) historyUnsubscribe();
            if (leaderboardUnsubscribe) leaderboardUnsubscribe();
            if (userDocUnsubscribe) userDocUnsubscribe();
            if (chartResizeObserver) chartResizeObserver.disconnect();
            openPositions = [];
            pendingOrders = [];
            if (chart) { chart.remove(); chart = null; }
            marketWatch.innerHTML = '';
            positionsTable.innerHTML = '';
            pendingOrdersTable.innerHTML = '';
            historyTable.innerHTML = '';
            leaderboardTable.innerHTML = '';
            resetAnalytics();
        }

        // --- Interactive Tutorial Logic ---
        function startTutorial() {
            currentTutorialStep = 0;
            tutorialOverlay.classList.remove('hidden');
            showTutorialStep(currentTutorialStep);
        }

        function showTutorialStep(stepIndex) {
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
            const step = TUTORIAL_STEPS[stepIndex];
            const targetElement = document.querySelector(step.selector);
            if (!targetElement) { endTutorial(); return; }
            targetElement.classList.add('tutorial-highlight');
            
            const targetRect = targetElement.getBoundingClientRect();
            tutorialBox.style.top = `${targetRect.bottom + 15}px`;
            tutorialBox.style.left = `${targetRect.left + (targetRect.width / 2) - (tutorialBox.offsetWidth / 2)}px`;
            if (parseInt(tutorialBox.style.left) < 10) tutorialBox.style.left = '10px';
            if (parseInt(tutorialBox.style.left) + tutorialBox.offsetWidth > window.innerWidth - 10) {
                 tutorialBox.style.left = `${window.innerWidth - tutorialBox.offsetWidth - 10}px`;
            }
            tutorialBox.querySelector('#tutorial-title').textContent = step.title;
            tutorialBox.querySelector('#tutorial-text').textContent = step.text;
            tutorialBox.querySelector('#tutorial-step').textContent = `Langkah ${stepIndex + 1} dari ${TUTORIAL_STEPS.length}`;
            tutorialBox.querySelector('#tutorial-next-btn').textContent = (stepIndex === TUTORIAL_STEPS.length - 1) ? 'Selesai' : 'Lanjut';
        }

        function endTutorial(skipped = false) {
            tutorialOverlay.classList.add('hidden');
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
            const userId = auth.currentUser?.uid;
            if (userId) { markTutorialAsCompleted(userId); }
        }
        
        async function markTutorialAsCompleted(userId) {
            await updateDoc(doc(db, 'users', userId), { hasCompletedTutorial: true });
        }

        tutorialOverlay.querySelector('#tutorial-next-btn').addEventListener('click', () => {
            currentTutorialStep++;
            if (currentTutorialStep < TUTORIAL_STEPS.length) { showTutorialStep(currentTutorialStep); } 
            else { endTutorial(); }
        });

        tutorialOverlay.querySelector('#tutorial-skip-btn').addEventListener('click', () => endTutorial(true));
        
        // --- Charting Logic ---
        function setupChart() {
            // Use requestAnimationFrame to wait for the next browser paint
            requestAnimationFrame(() => {
                if (initializeChart()) {
                    updateChart(activeChartPair);
                } else {
                    console.error("Gagal menginisialisasi grafik setelah menunggu render.");
                    chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-red-400">Gagal memuat grafik. Coba muat ulang.</div>`;
                }
            });
        }

        function initializeChart() {
            try {
                if (typeof LightweightCharts === 'undefined' || typeof LightweightCharts.createChart !== 'function' || chartContainer.clientWidth <= 0) {
                    return false;
                }

                if (chart) chart.remove();
                chartContainer.innerHTML = '';

                chart = LightweightCharts.createChart(chartContainer, {
                    width: chartContainer.clientWidth,
                    height: chartContainer.clientHeight,
                    layout: { background: { color: '#1e293b' }, textColor: 'rgba(255, 255, 255, 0.9)' },
                    grid: { vertLines: { color: '#334155' }, horzLines: { color: '#334155' } },
                    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                    rightPriceScale: { borderColor: '#475569' },
                    timeScale: { borderColor: '#475569' },
                });
                
                candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#22c55e', wickUpColor: '#22c55e', downColor: '#ef4444', wickDownColor: '#ef4444', borderVisible: false,
                });
                
                if (chartResizeObserver) chartResizeObserver.disconnect();
                chartResizeObserver = new ResizeObserver(entries => {
                    const entry = entries[0];
                    if (entry && entry.contentRect.width > 0) {
                        chart.resize(entry.contentRect.width, entry.contentRect.height);
                    }
                });
                chartResizeObserver.observe(chartContainer);

                return true;
            } catch (error) {
                console.error("Exception during chart initialization:", error);
                chartContainer.innerHTML = `<div class="flex items-center justify-center h-full text-red-400">Terjadi error saat membuat grafik.</div>`;
                return false;
            }
        }

        function updateChart(pair) {
            if (!chart || !candlestickSeries) return;
            chartTitle.textContent = `Grafik Harga: ${pair}`;
            candlestickSeries.setData(historicalData[pair] || []);
            chart.timeScale().fitContent();
        }

        // --- Market Data Simulation ---
        function listenToMarketData() {
            ASSETS.forEach(pair => {
                let currentPrice = getBasePrice(pair);
                historicalData[pair] = [];
                for (let i = 0; i < 100; i++) {
                    const open = currentPrice;
                    const change = (Math.random() - 0.5) * open * getVolatility(pair) * 5;
                    const close = open + change;
                    const high = Math.max(open, close) + Math.random() * open * getVolatility(pair);
                    const low = Math.min(open, close) - Math.random() * open * getVolatility(pair);
                    historicalData[pair].push({ time: Math.floor(Date.now() / 1000) - (100 - i) * 60, open, high, low, close });
                    currentPrice = close;
                }
                currentPrices[pair] = { price: currentPrice, direction: 'stale' };
            });
            renderMarketWatch();
            if (chart) {
                updateChart(activeChartPair);
            }
            if (priceInterval) clearInterval(priceInterval);
            priceInterval = setInterval(() => {
                ASSETS.forEach(pair => {
                    if (!historicalData[pair] || historicalData[pair].length === 0) return;
                    const lastBar = historicalData[pair][historicalData[pair].length - 1];
                    const open = lastBar.close;
                    const volatility = getVolatility(pair);
                    const change = (Math.random() - 0.5) * open * volatility;
                    const close = open + change;
                    const high = Math.max(open, close) + Math.random() * open * volatility * 0.5;
                    const low = Math.min(open, close) - Math.random() * open * volatility * 0.5;
                    const newBar = { time: Math.floor(Date.now() / 1000), open, high, low, close };
                    historicalData[pair].push(newBar);
                    if(historicalData[pair].length > 200) historicalData[pair].shift();
                    if (pair === activeChartPair && candlestickSeries) { candlestickSeries.update(newBar); }
                    const oldPrice = currentPrices[pair].price;
                    currentPrices[pair] = { price: close, direction: close > oldPrice ? 'up' : (close < oldPrice ? 'down' : 'stale') };
                });
                renderMarketWatch();
                updateAllPositionsProfitLoss();
                checkPriceTriggers();
            }, 2000);
        }
        
        function populatePairSelect() {
            pairSelect.innerHTML = ASSETS.map(p => `<option value="${p}">${p}</option>`).join('');
        }
        function getBasePrice(pair) {
            const prices = {'EUR/USD': 1.0850, 'GBP/USD': 1.2730, 'USD/JPY': 150.50, 'AUD/USD': 0.6550, 'USD/CAD': 1.3520, 'XAU/USD': 2350.55, 'BTC/USD': 68500.00};
            return prices[pair] || 1.0;
        }
        function getVolatility(pair) {
            if (pair === 'BTC/USD') return 0.0020;
            if (pair === 'XAU/USD') return 0.0010;
            return 0.0005;
        }
        function checkPriceTriggers() {
            const userId = auth.currentUser?.uid;
            if (!userId) return;
            for (const trade of openPositions) {
                const currentPrice = currentPrices[trade.pair]?.price;
                if (!currentPrice) continue;
                let closeReason = null;
                if (trade.stopLoss && ((trade.orderType.includes('buy') && currentPrice <= trade.stopLoss) || (trade.orderType.includes('sell') && currentPrice >= trade.stopLoss))) { closeReason = 'sl_hit';
                } else if (trade.takeProfit && ((trade.orderType.includes('buy') && currentPrice >= trade.takeProfit) || (trade.orderType.includes('sell') && currentPrice <= trade.takeProfit))) { closeReason = 'tp_hit'; }
                if(closeReason) { closePosition(trade.id, closeReason); }
            }
            for (const order of pendingOrders) {
                const currentPrice = currentPrices[order.pair]?.price;
                if (!currentPrice) continue;
                let triggered = false;
                switch (order.orderType) {
                    case 'buy_limit':  if (currentPrice <= order.entryPrice) triggered = true; break;
                    case 'sell_limit': if (currentPrice >= order.entryPrice) triggered = true; break;
                    case 'buy_stop':   if (currentPrice >= order.entryPrice) triggered = true; break;
                    case 'sell_stop':  if (currentPrice <= order.entryPrice) triggered = true; break;
                }
                if (triggered) { activatePendingOrder(order.id); }
            }
        }
        async function placeOrder() {
            const userId = auth.currentUser?.uid;
            if (!userId) return;
            const orderData = {
                pair: pairSelect.value,
                size: parseFloat(document.getElementById('trade-size').value),
                orderType: orderTypeSelect.value,
                stopLoss: parseFloat(document.getElementById('stop-loss').value) || null,
                takeProfit: parseFloat(document.getElementById('take-profit').value) || null,
                entryPrice: parseFloat(entryPriceInput.value) || null,
            };
            if (isNaN(orderData.size) || orderData.size <= 0) return showTradeMessage('Ukuran (lot) tidak valid.', true);
            const isPending = orderData.orderType !== 'market';
            if (isPending && (!orderData.entryPrice || orderData.entryPrice <= 0)) return showTradeMessage('Harga entri untuk pending order tidak valid.', true);
            try {
                const tradesCollectionRef = collection(db, 'users', userId, 'trades');
                const docPayload = { ...orderData, status: isPending ? 'pending' : 'open', createdTimestamp: serverTimestamp() };
                if (!isPending) {
                    docPayload.openPrice = currentPrices[orderData.pair].price;
                    docPayload.openTimestamp = serverTimestamp();
                }
                await addDoc(tradesCollectionRef, docPayload);
                showTradeMessage(`Order berhasil ditempatkan.`, false);
                ['trade-size', 'stop-loss', 'take-profit', 'entry-price'].forEach(id => document.getElementById(id).value = '');
                orderTypeSelect.value = 'market';
                entryPriceContainer.classList.add('hidden');
            } catch(error) { showTradeMessage('Gagal menempatkan order.', true); }
        }
        async function activatePendingOrder(orderId) {
            const userId = auth.currentUser?.uid;
            if(!userId) return;
            const orderDocRef = doc(db, 'users', userId, 'trades', orderId);
            try {
                const orderDoc = await getDoc(orderDocRef);
                if (orderDoc.exists() && orderDoc.data().status === 'pending') {
                    await updateDoc(orderDocRef, { status: 'open', openPrice: orderDoc.data().entryPrice, openTimestamp: serverTimestamp() });
                    showToast(`Order ${orderDoc.data().pair} telah aktif!`);
                }
            } catch (error) { console.error("Error activating order: ", error); }
        }
        async function cancelPendingOrder(orderId) {
             const userId = auth.currentUser?.uid;
            if(!userId) return;
            const orderDocRef = doc(db, 'users', userId, 'trades', orderId);
            try { await deleteDoc(orderDocRef); showToast('Order berhasil dibatalkan.'); } 
            catch (error) { showTradeMessage('Gagal membatalkan order.', true); }
        }
        function listenToPositions(userId) {
            if (positionsUnsubscribe) positionsUnsubscribe(); 
            const q = query(collection(db, 'users', userId, 'trades'), where("status", "==", "open"));
            positionsUnsubscribe = onSnapshot(q, (snapshot) => {
                openPositions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                positionsTable.innerHTML = openPositions.length ? openPositions.map(tradeToRowHTML).join('') : `<tr><td colspan="5" class="text-center py-4 text-slate-500">Tidak ada posisi terbuka.</td></tr>`;
            });
        }
        function listenToPendingOrders(userId) {
            if (pendingOrdersUnsubscribe) pendingOrdersUnsubscribe();
            const q = query(collection(db, 'users', userId, 'trades'), where("status", "==", "pending"));
            pendingOrdersUnsubscribe = onSnapshot(q, (snapshot) => {
                pendingOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                pendingOrdersTable.innerHTML = pendingOrders.length ? pendingOrders.map(pendingOrderToRowHTML).join('') : `<tr><td colspan="4" class="text-center py-4 text-slate-500">Tidak ada order tertunda.</td></tr>`;
            });
        }
        function pendingOrderToRowHTML(order) {
            const orderTypeText = order.orderType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            return `
                 <tr data-order-id="${order.id}" class="border-b border-slate-700 hover:bg-slate-700/50">
                    <td class="px-4 py-3"><div class="font-semibold">${order.pair}</div><div class="text-xs uppercase font-bold text-indigo-400">${orderTypeText} @ ${order.size} lot</div></td>
                    <td class="px-4 py-3">${formatPrice(order.entryPrice, order.pair)}</td>
                    <td class="px-4 py-3 text-xs"><div class="text-red-400">SL: ${formatPrice(order.stopLoss, order.pair)}</div><div class="text-green-400">TP: ${formatPrice(order.takeProfit, order.pair)}</div></td>
                    <td class="px-4 py-3"><button class="cancel-order-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-3 rounded-md">Batal</button></td>
                </tr>`;
        }
        orderTypeSelect.addEventListener('change', () => { entryPriceContainer.classList.toggle('hidden', orderTypeSelect.value === 'market'); });
        placeOrderBtn.addEventListener('click', () => {
            const orderType = orderTypeSelect.value; const pair = pairSelect.value; const size = document.getElementById('trade-size').value;
            let message = (orderType === 'market') ? `Anda akan membuka posisi market ${size} lot ${pair}. Lanjutkan?` : `Anda akan menempatkan ${orderType.replace('_', ' ')} ${size} lot ${pair} di harga ${entryPriceInput.value}. Lanjutkan?`;
            showConfirmationModal({ title: 'Konfirmasi Order', message, onConfirm: () => placeOrder() });
        });
        pendingOrdersTable.addEventListener('click', (e) => {
            if(e.target.classList.contains('cancel-order-btn')) {
                const orderId = e.target.closest('tr').dataset.orderId;
                showConfirmationModal({ title: 'Batalkan Order', message: `Anda yakin ingin membatalkan order ini?`, onConfirm: () => cancelPendingOrder(orderId) });
            }
        });
        function switchTab(activeTab) {
            ['open-positions', 'pending-orders', 'history'].forEach(tabName => {
                document.getElementById(`${tabName}-tab`).classList.toggle('active', tabName === activeTab);
                document.getElementById(`${tabName}-view`).classList.toggle('hidden', tabName !== activeTab);
            });
        }
        openPositionsTab.addEventListener('click', () => switchTab('open-positions'));
        pendingOrdersTab.addEventListener('click', () => switchTab('pending-orders'));
        historyTab.addEventListener('click', () => switchTab('history'));
        function formatPrice(price, pair) { 
            if (price === null || typeof price === 'undefined') return '-';
            if (pair === 'BTC/USD') return price.toFixed(2);
            if (pair === 'XAU/USD' || pair?.includes('JPY')) return price.toFixed(2);
            return price.toFixed(4); 
        }
        function getPointValue(pair) {
            if (pair?.includes('JPY')) return 1000; if (pair === 'XAU/USD') return 100; if (pair === 'BTC/USD') return 1; return 100000;
        }
        function calculateProfitLoss(trade) {
            const currentPrice = currentPrices[trade.pair]?.price;
            if (!currentPrice) return 0.00;
            const pointValue = getPointValue(trade.pair);
            const priceDiff = trade.orderType.includes('buy') ? (currentPrice - trade.openPrice) : (trade.openPrice - currentPrice);
            return priceDiff * pointValue * trade.size;
        }
        const authForm = document.getElementById('auth-form');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        async function handleAuth(authFn, isRegister = false) {
            const email = authForm.email.value; const password = authForm.password.value; authError.textContent = '';
            if (isRegister && password.length < 6) { authError.textContent = "Password minimal 6 karakter."; return; }
            try { const userCredential = await authFn(auth, email, password); if (isRegister) { await initializeUserProfile(userCredential.user.uid, email); } } 
            catch (error) { authError.textContent = isRegister ? "Gagal mendaftar. Email mungkin sudah ada." : "Gagal masuk. Periksa email/password."; }
        }
        loginBtn.addEventListener('click', async () => handleAuth(signInWithEmailAndPassword));
        registerBtn.addEventListener('click', async () => handleAuth(createUserWithEmailAndPassword, true));
        logoutBtn.addEventListener('click', () => signOut(auth));
        function listenToUserDocument(userId) {
            if(userDocUnsubscribe) userDocUnsubscribe();
            userDocUnsubscribe = onSnapshot(doc(db, 'users', userId), (doc) => {
                if(doc.exists()) {
                    const userData = doc.data();
                    accountBalanceDisplay.textContent = `$${userData.balance.toFixed(2)}`;
                    renderAchievements(userData.achievements || []);
                }
            });
        }
        function renderMarketWatch() {
            marketWatch.innerHTML = Object.entries(currentPrices).map(([pair, { price, direction }]) => `
                <div data-pair="${pair}" class="market-pair flex justify-between items-center p-2 rounded-lg bg-slate-700/50 cursor-pointer transition-colors duration-200 ${pair === activeChartPair ? 'active' : ''}">
                    <span class="font-semibold">${pair}</span>
                    <span class="font-mono text-lg price-${direction}">${formatPrice(price, pair)}</span>
                </div>`).join('');
        }
        marketWatch.addEventListener('click', (e) => {
            const pairElement = e.target.closest('.market-pair');
            if(pairElement) { activeChartPair = pairElement.dataset.pair; updateChart(activeChartPair); renderMarketWatch(); }
        });
        function showTradeMessage(message, isError) {
            tradeMessage.textContent = message;
            tradeMessage.className = `text-sm mt-4 text-center ${isError ? 'text-red-500' : 'text-green-500'}`;
            setTimeout(() => tradeMessage.textContent = '', 3000);
        }
        function listenToHistory(userId) {
            if (historyUnsubscribe) historyUnsubscribe();
            // REMOVED orderBy from query to prevent needing an index
            const q = query(collection(db, 'users', userId, 'trades'), where("status", "==", "closed"));
            historyUnsubscribe = onSnapshot(q, (snapshot) => {
                const history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // ADDED client-side sorting
                history.sort((a, b) => {
                    const timeA = a.closeTimestamp?.seconds || 0;
                    const timeB = b.closeTimestamp?.seconds || 0;
                    return timeB - timeA;
                });

                historyTable.innerHTML = history.length ? history.map(historyToRowHTML).join('') : `<tr><td colspan="4" class="text-center py-4 text-slate-500">Tidak ada riwayat trading.</td></tr>`;
                calculateAndRenderAnalytics(history);
                checkAndAwardAchievements(userId, history);
            }, (error) => {
                console.error("History listener failed:", error);
                historyTable.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-400">Gagal memuat riwayat.</td></tr>`
            });
        }
        function tradeToRowHTML(trade) {
            const pl = calculateProfitLoss(trade); const plClass = pl >= 0 ? 'text-green-500' : 'text-red-500';
            return `
                <tr data-trade-id="${trade.id}" class="border-b border-slate-700 hover:bg-slate-700/50">
                    <td class="px-4 py-3"><div class="font-semibold">${trade.pair}</div><div class="text-xs uppercase font-bold ${trade.orderType.includes('buy') ? 'text-green-500' : 'text-red-500'}">${trade.orderType.replace(/_/g, ' ')} @ ${trade.size} lot</div></td>
                    <td class="px-4 py-3">${formatPrice(trade.openPrice, trade.pair)}</td>
                    <td class="px-4 py-3 text-xs"><div class="text-red-400">SL: ${formatPrice(trade.stopLoss, trade.pair)}</div><div class="text-green-400">TP: ${formatPrice(trade.takeProfit, trade.pair)}</div></td>
                    <td class="px-4 py-3 font-mono profit-loss ${plClass}">${pl.toFixed(2)}</td>
                    <td class="px-4 py-3"><button class="close-pos-btn bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold py-1 px-3 rounded-md">Tutup</button></td>
                </tr>`;
        }
        function historyToRowHTML(trade) {
            const plClass = trade.profitLoss >= 0 ? 'text-green-500' : 'text-red-500';
            const closeTime = trade.closeTimestamp ? new Date(trade.closeTimestamp.seconds * 1000).toLocaleString('id-ID') : 'N/A';
            return `
                <tr class="border-b border-slate-700">
                    <td class="px-4 py-3"><div class="font-semibold">${trade.pair}</div><div class="text-xs uppercase font-bold ${trade.orderType.includes('buy') ? 'text-green-500' : 'text-red-500'}">${trade.orderType.replace(/_/g, ' ')} @ ${trade.size} lot</div></td>
                    <td class="px-4 py-3 text-xs"><div>Open: ${formatPrice(trade.openPrice, trade.pair)}</div><div>Close: ${formatPrice(trade.closePrice, trade.pair)}</div></td>
                    <td class="px-4 py-3 text-xs">${closeTime}</td>
                    <td class="px-4 py-3 font-mono ${plClass}">${trade.profitLoss.toFixed(2)}</td>
                </tr>`;
        }
        function updateAllPositionsProfitLoss() {
            document.querySelectorAll('#positions-table tr[data-trade-id]').forEach(row => {
                const tradeId = row.dataset.tradeId; const trade = openPositions.find(p => p.id === tradeId);
                if (trade) {
                    const pl = calculateProfitLoss(trade); const plElement = row.querySelector('.profit-loss');
                    plElement.textContent = pl.toFixed(2); plElement.classList.toggle('text-green-500', pl >= 0); plElement.classList.toggle('text-red-500', pl < 0);
                }
            });
        }
        positionsTable.addEventListener('click', (e) => {
            if(e.target.classList.contains('close-pos-btn')) {
                const tradeId = e.target.closest('tr').dataset.tradeId; const trade = openPositions.find(p => p.id === tradeId);
                if (trade) { showConfirmationModal({ title: 'Tutup Posisi', message: `Anda akan menutup posisi ${trade.size} lot ${trade.pair}. Lanjutkan?`, onConfirm: () => closePosition(trade.id, 'manual') }); }
            }
        });
        async function closePosition(tradeId, reason = 'manual') {
            const userId = auth.currentUser?.uid; if(!userId) return;
            const tradeDocRef = doc(db, 'users', userId, 'trades', tradeId); const userDocRef = doc(db, 'users', userId); const leaderboardDocRef = doc(db, 'leaderboard', userId);
            try {
                const batch = writeBatch(db); const tradeDoc = await getDoc(tradeDocRef); const userDoc = await getDoc(userDocRef);
                if (!tradeDoc.exists() || !userDoc.exists() || tradeDoc.data().status !== 'open') return;
                const tradeData = tradeDoc.data(); const profitLoss = calculateProfitLoss(tradeData); const newBalance = userDoc.data().balance + profitLoss;
                batch.update(tradeDocRef, { status: 'closed', closePrice: currentPrices[tradeData.pair].price, closeTimestamp: serverTimestamp(), profitLoss, closeReason: reason });
                batch.update(userDocRef, { balance: newBalance }); batch.update(leaderboardDocRef, { balance: newBalance });
                await batch.commit();
                if (reason === 'manual') showTradeMessage('Posisi berhasil ditutup.', false);
            } catch (error) { if (reason === 'manual') showTradeMessage('Gagal menutup posisi.', true); }
        }
        function calculateAndRenderAnalytics(closedTrades) {
            const totalTrades = closedTrades.length; if (totalTrades === 0) { resetAnalytics(); return; }
            const winningTrades = closedTrades.filter(t => t.profitLoss > 0).length; const winRate = (winningTrades / totalTrades) * 100;
            const totalProfitLoss = closedTrades.reduce((sum, t) => sum + t.profitLoss, 0); const averageProfitLoss = totalProfitLoss / totalTrades;
            analyticsTotalTrades.textContent = totalTrades; analyticsWinRate.textContent = `${winRate.toFixed(1)}%`;
            analyticsTotalPl.textContent = `$${totalProfitLoss.toFixed(2)}`; analyticsTotalPl.className = `text-2xl font-bold ${totalProfitLoss >= 0 ? 'text-green-400' : 'text-red-400'}`;
            analyticsAvgPl.textContent = `$${averageProfitLoss.toFixed(2)}`; analyticsAvgPl.className = `text-2xl font-bold ${averageProfitLoss >= 0 ? 'text-green-400' : 'text-red-400'}`;
        }
        function resetAnalytics() {
            analyticsTotalTrades.textContent = '0'; analyticsWinRate.textContent = 'N/A';
            analyticsTotalPl.textContent = '$0.00'; analyticsTotalPl.className = 'text-2xl font-bold text-white';
            analyticsAvgPl.textContent = '$0.00'; analyticsAvgPl.className = 'text-2xl font-bold text-white';
        }
        function showConfirmationModal({ title, message, onConfirm }) {
            modalTitle.textContent = title; modalMessage.textContent = message;
            const newConfirmBtn = modalConfirmBtn.cloneNode(true);
            modalConfirmBtn.parentNode.replaceChild(newConfirmBtn, modalConfirmBtn);
            newConfirmBtn.addEventListener('click', () => { onConfirm(); hideConfirmationModal(); }, { once: true });
            confirmationModal.classList.remove('hidden');
        }
        function hideConfirmationModal() { confirmationModal.classList.add('hidden'); }
        modalCancelBtn.addEventListener('click', hideConfirmationModal);
        function listenToLeaderboard() {
            if (leaderboardUnsubscribe) leaderboardUnsubscribe();
            const q = query(collection(db, 'leaderboard'), orderBy("balance", "desc"), limit(10));
            leaderboardUnsubscribe = onSnapshot(q, (snapshot) => { renderLeaderboard(snapshot.docs.map(doc => doc.data())); },
            (error) => {
                console.error("Leaderboard listener failed:", error);
                leaderboardTable.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-red-400">Gagal memuat papan peringkat. Periksa aturan keamanan Firestore Anda.</td></tr>`
            });
        }
        function renderLeaderboard(users) {
            leaderboardTable.innerHTML = users.map((user, index) => `<tr class="border-b border-slate-700/50"><td class="py-2 px-2 font-bold">${index + 1}</td><td class="py-2 px-2">${user.email.split('@')[0]}</td><td class="py-2 px-2 text-right font-mono text-green-400">$${user.balance.toFixed(2)}</td></tr>`).join('');
        }
        async function checkAndAwardAchievements(userId, closedTrades) {
            const userDoc = await getDoc(doc(db, 'users', userId)); if (!userDoc.exists()) return;
            const { achievements: earnedAchievements = [], balance: newBalance } = userDoc.data();
            const achievementsToAward = [];
            if (!earnedAchievements.includes('first_trade') && closedTrades.length > 0) achievementsToAward.push('first_trade');
            if (!earnedAchievements.includes('first_profit') && closedTrades.some(t => t.profitLoss > 0)) achievementsToAward.push('first_profit');
            if (!earnedAchievements.includes('profit_streak_3') && closedTrades.length >= 3) {
                if (closedTrades.slice(0, 3).every(t => t.profitLoss > 0)) achievementsToAward.push('profit_streak_3');
            }
            if (!earnedAchievements.includes('balance_12k') && newBalance >= 12000) achievementsToAward.push('balance_12k');
            if (!earnedAchievements.includes('balance_15k') && newBalance >= 15000) achievementsToAward.push('balance_15k');
            if (achievementsToAward.length > 0) {
                await updateDoc(doc(db, 'users', userId), { achievements: arrayUnion(...achievementsToAward) });
                achievementsToAward.forEach(id => { showToast(`Pencapaian Diraih: ${ACHIEVEMENT_DEFINITIONS[id].name}!`); });
            }
        }
        function renderAchievements(earnedIds) {
            achievementsContainer.innerHTML = Object.entries(ACHIEVEMENT_DEFINITIONS).map(([id, ach]) => {
                const earned = earnedIds.includes(id);
                return `<div class="relative has-tooltip"><span class="text-3xl ${earned ? '' : 'opacity-20 grayscale'}">${ach.icon}</span><div class="tooltip absolute bottom-full mb-2 w-48 bg-slate-700 text-white text-xs text-center rounded-lg py-2 px-3 opacity-0 invisible transition-opacity duration-300 z-10"><p class="font-bold">${ach.name}</p><p class="text-slate-300">${ach.description}</p>${!earned ? '<p class="text-red-400 font-bold mt-1">[TERKUNCI]</p>' : ''}</div></div>`;
            }).join('');
        }
        function showToast(message) {
            toastMessage.textContent = message; toastNotification.classList.add('show');
            setTimeout(() => { toastNotification.classList.remove('show'); }, 4000);
        }
    </script>
</body>
</html>

