<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIFX Trading Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .price-up { color: #22c55e; /* green-500 */ }
        .price-down { color: #ef4444; /* red-500 */ }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .control-btn {
            padding: 4px 10px;
            border-radius: 6px;
            background-color: #374151; /* gray-700 */
            font-size: 12px;
            font-weight: 500;
            transition: background-color 0.2s;
            border: 1px solid #4b5563;
        }
        .control-btn:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .control-btn.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 600;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg">Loading Trading Desk...</p>
        </div>
    </div>

    <div id="app-content" class="container mx-auto p-2 sm:p-4 max-w-7xl hidden">
        <header class="mb-4">
            <h1 class="text-3xl font-bold text-white">MIFX Trading Clone</h1>
            <p class="text-sm text-gray-400">Offline Demo Account</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-12 gap-4">

            <!-- Left Panel: Market Watch & Account Info -->
            <aside class="lg:col-span-3 space-y-4">
                <!-- Account Info -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Account Info</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between"><span>Balance:</span> <span id="balance-value" class="font-mono font-semibold">$0.00</span></div>
                        <div class="flex justify-between"><span>Equity:</span> <span id="equity-value" class="font-mono font-semibold">$0.00</span></div>
                        <div class="flex justify-between"><span>Floating P/L:</span> <span id="pl-value" class="font-mono font-semibold">$0.00</span></div>
                        <hr class="border-gray-700 my-2">
                        <div class="flex justify-between"><span>Margin:</span> <span id="margin-value" class="font-mono font-semibold">$0.00</span></div>
                        <div class="flex justify-between"><span>Free Margin:</span> <span id="free-margin-value" class="font-mono font-semibold">$0.00</span></div>
                        <div class="flex justify-between"><span>Margin Level:</span> <span id="margin-level-value" class="font-mono font-semibold">0.00%</span></div>
                    </div>
                </div>

                <!-- Market Watch -->
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-3 border-b border-gray-700 pb-2">Market Watch</h2>
                    <div id="market-watch-list" class="space-y-2 h-64 overflow-y-auto">
                        <!-- Market data will be injected here by JS -->
                    </div>
                </div>
            </aside>

            <!-- Center Panel: Trading -->
            <section class="lg:col-span-9">
                <div class="bg-gray-800 rounded-lg shadow-lg">
                    <!-- Chart Controls -->
                    <div class="flex flex-wrap items-center space-x-2 p-2 bg-gray-900/50 rounded-t-lg border-b border-gray-700">
                        <div id="interval-selector" class="flex items-center space-x-2 border-r border-gray-700 pr-3">
                            <button class="control-btn active" data-interval="60">1M</button>
                            <button class="control-btn" data-interval="300">5M</button>
                            <button class="control-btn" data-interval="900">15M</button>
                            <button class="control-btn" data-interval="3600">1H</button>
                        </div>
                        <div id="chart-type-selector" class="flex items-center space-x-2 border-r border-gray-700 px-3">
                             <button class="control-btn active" data-type="candlestick">Candles</button>
                             <button class="control-btn" data-type="line">Line</button>
                             <button class="control-btn" data-type="bar">Bar</button>
                        </div>
                        <div class="flex items-center space-x-3 px-3">
                            <label class="flex items-center space-x-2 text-sm cursor-pointer">
                                <input type="checkbox" id="ma-toggle" class="form-checkbox h-4 w-4 bg-gray-700 border-gray-600 text-blue-500 rounded focus:ring-blue-500">
                                <span>MA (20)</span>
                            </label>
                        </div>
                    </div>
                    <!-- Chart -->
                    <div id="chart-container" class="w-full h-72 md:h-96 bg-gray-800"></div>

                    <!-- Trading Panel -->
                    <div class="p-4">
                        <div class="border-b border-gray-700 pb-4 mb-4">
                            <h2 class="text-xl font-semibold mb-2">Trade Terminal</h2>
                            <div class="flex flex-wrap items-center gap-4">
                                <div>
                                    <label for="instrument-select" class="block text-sm font-medium text-gray-400">Instrument</label>
                                    <select id="instrument-select" class="bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-blue-500 focus:border-blue-500">
                                        <option value="EURUSD">EUR/USD</option>
                                        <option value="XAUUSD">GOLD</option>
                                        <option value="GBPUSD">GBP/USD</option>
                                        <option value="USDJPY">USD/JPY</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="lot-size" class="block text-sm font-medium text-gray-400">Volume (Lot)</label>
                                    <input type="number" id="lot-size" value="0.01" step="0.01" min="0.01" class="w-24 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="stop-loss" class="block text-sm font-medium text-gray-400">Stop Loss</label>
                                    <input type="number" id="stop-loss" placeholder="Price" step="0.0001" class="w-28 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="take-profit" class="block text-sm font-medium text-gray-400">Take Profit</label>
                                    <input type="number" id="take-profit" placeholder="Price" step="0.0001" class="w-28 bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div class="flex-grow flex items-end h-full space-x-2 pt-5">
                                    <button id="sell-button" class="w-full h-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                                        SELL
                                    </button>
                                    <button id="buy-button" class="w-full h-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                                        BUY
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Tabs for Open Positions & History -->
                        <div>
                            <div class="flex border-b border-gray-700">
                                <button id="tab-positions" class="py-2 px-4 text-white border-b-2 border-blue-500 font-semibold">Open Positions (<span id="positions-count">0</span>)</button>
                                <button id="tab-history" class="py-2 px-4 text-gray-400">History</button>
                            </div>

                            <div id="positions-content" class="mt-4">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-sm text-left">
                                        <thead class="bg-gray-700 text-xs uppercase">
                                            <tr>
                                                <th class="p-2">Symbol</th>
                                                <th class="p-2">Type</th>
                                                <th class="p-2">Volume</th>
                                                <th class="p-2">Open Price</th>
                                                <th class="p-2">SL</th>
                                                <th class="p-2">TP</th>
                                                <th class="p-2">Current Price</th>
                                                <th class="p-2">Profit/Loss</th>
                                                <th class="p-2">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="open-positions-body" class="divide-y divide-gray-700"></tbody>
                                    </table>
                                </div>
                            </div>

                            <div id="history-content" class="mt-4 hidden">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full text-sm text-left">
                                        <thead class="bg-gray-700 text-xs uppercase">
                                            <tr>
                                                <th class="p-2">Symbol</th>
                                                <th class="p-2">Type</th>
                                                <th class="p-2">Volume</th>
                                                <th class="p-2">Open Price</th>
                                                <th class="p-2">Close Price</th>
                                                <th class="p-2">Profit/Loss</th>
                                            </tr>
                                        </thead>
                                        <tbody id="history-body" class="divide-y divide-gray-700"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-white">Notification</h3>
            <p id="modal-message" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end">
                <button id="modal-close" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">OK</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Global State & Config ---
            const LEVERAGE = 100;
            const CONTRACT_SIZES = { 'EURUSD': 100000, 'GBPUSD': 100000, 'USDJPY': 100000, 'XAUUSD': 100 };
            let marketData = {
                'EURUSD': { bid: 1.0850, ask: 1.0852, lastBid: 1.0850 },
                'XAUUSD': { bid: 2350.50, ask: 2350.90, lastBid: 2350.50 },
                'GBPUSD': { bid: 1.2730, ask: 1.2733, lastBid: 1.2730 },
                'USDJPY': { bid: 157.10, ask: 157.13, lastBid: 157.10 },
            };
            let openPositions = [];
            let history = [];
            let accountInfo = {};
            let chart, mainSeries, maSeries, currentChartData = [], chartResizeObserver = null;
            let marketIntervalId = null;
            let currentInterval = 60;
            let currentChartType = 'candlestick';
            const MA_PERIOD = 20;
            let playbackIndex = 150;
            const TOTAL_HISTORY_LENGTH = 1000;
            let fullMarketHistory = {};
            
            // --- DOM Elements ---
            const marginValueEl = document.getElementById('margin-value');
            const freeMarginValueEl = document.getElementById('free-margin-value');
            const marginLevelValueEl = document.getElementById('margin-level-value');
            const loadingOverlay = document.getElementById('loading-overlay');
            const appContent = document.getElementById('app-content');
            const marketWatchList = document.getElementById('market-watch-list');
            const balanceValueEl = document.getElementById('balance-value');
            const equityValueEl = document.getElementById('equity-value');
            const plValueEl = document.getElementById('pl-value');
            const buyButton = document.getElementById('buy-button');
            const sellButton = document.getElementById('sell-button');
            const instrumentSelect = document.getElementById('instrument-select');
            const lotSizeInput = document.getElementById('lot-size');
            const stopLossInput = document.getElementById('stop-loss');
            const takeProfitInput = document.getElementById('take-profit');
            const openPositionsBody = document.getElementById('open-positions-body');
            const historyBody = document.getElementById('history-body');
            const positionsCountEl = document.getElementById('positions-count');
            const chartContainer = document.getElementById('chart-container');
            const intervalSelector = document.getElementById('interval-selector');
            const chartTypeSelector = document.getElementById('chart-type-selector');
            const maToggle = document.getElementById('ma-toggle');
            const tabPositions = document.getElementById('tab-positions');
            const tabHistory = document.getElementById('tab-history');
            const positionsContent = document.getElementById('positions-content');
            const historyContent = document.getElementById('history-content');
            const messageModal = document.getElementById('message-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalClose = document.getElementById('modal-close');

            // --- Custom Modal & Helpers ---
            function showModal(title, message) { modalTitle.textContent = title; modalMessage.textContent = message; messageModal.classList.remove('hidden'); }
            modalClose.addEventListener('click', () => messageModal.classList.add('hidden'));

            function seededRandom(seed) {
                let x = Math.sin(seed) * 10000;
                return x - Math.floor(x);
            }
            
            // --- Data Persistence (localStorage) ---
            function saveState() {
                const positionsToSave = openPositions.map(pos => { const { priceLine, ...rest } = pos; return rest; });
                const state = { openPositions: positionsToSave, history, accountInfo, fullMarketHistory };
                localStorage.setItem('tradingAppState', JSON.stringify(state));
            }

            function loadState() {
                const savedState = localStorage.getItem('tradingAppState');
                let state = {};
                if (savedState) {
                    try { state = JSON.parse(savedState); } catch (e) { console.error("Could not parse state, resetting.", e); state = {}; }
                }

                openPositions = state.openPositions || [];
                history = state.history || [];
                
                if (state.accountInfo && state.accountInfo.balance !== undefined) {
                    accountInfo = state.accountInfo;
                } else {
                    accountInfo = { balance: 10000, equity: 10000 };
                }

                if (state.fullMarketHistory && Object.keys(state.fullMarketHistory).length > 0) {
                    fullMarketHistory = state.fullMarketHistory;
                } else {
                    fullMarketHistory = {};
                }
            }
            
            // --- Core Application Functions ---
            function initChart() { if (!window.LightweightCharts) { console.error("Library not loaded."); return; } if (!chartContainer || chartContainer.clientWidth === 0) { console.error("Chart container not ready."); return; } const { createChart, CrosshairMode } = window.LightweightCharts; chart = createChart(chartContainer, { width: chartContainer.clientWidth, height: chartContainer.clientHeight, layout: { backgroundColor: '#1f2937', textColor: 'rgba(255, 255, 255, 0.9)' }, grid: { vertLines: { color: '#374151' }, horzLines: { color: '#374151' } }, crosshair: { mode: CrosshairMode.Normal }, rightPriceScale: { borderColor: '#4b5563' }, timeScale: { borderColor: '#4b5563', timeVisible: true, secondsVisible: false } }); setChartType(currentChartType); chartResizeObserver = new ResizeObserver(entries => { if (entries.length === 0 || !chart) { return; } const newRect = entries[0].contentRect; chart.applyOptions({ width: newRect.width, height: newRect.height }); }); chartResizeObserver.observe(chartContainer); }
            
            function clearAllPriceLineReferences() {
                openPositions.forEach(pos => pos.priceLine = null);
            }
            
            function setChartType(type) { if (mainSeries) { chart.removeSeries(mainSeries); mainSeries = null; clearAllPriceLineReferences(); } switch(type) { case 'bar': mainSeries = chart.addBarSeries({ upColor: '#22c55e', downColor: '#ef4444' }); break; case 'line': mainSeries = chart.addLineSeries({ color: '#3b82f6' }); break; case 'candlestick': default: mainSeries = chart.addCandlestickSeries({ upColor: '#22c55e', downColor: '#ef4444', borderDownColor: '#ef4444', borderUpColor: '#22c55e', wickDownColor: '#ef4444', wickUpColor: '#22c55e' }); break; } currentChartType = type; loadChartData(instrumentSelect.value, currentInterval); }
            function calculateSMA(data, period) { let result = []; for (let i = 0; i < data.length; i++) { if (i < period - 1) { result.push({ time: data[i].time }); } else { let sum = 0; for (let j = 0; j < period; j++) { sum += data[i - j].close; } result.push({ time: data[i].time, value: sum / period }); } } return result; }
            function updateMA() { if (!maToggle.checked) { if (maSeries) { chart.removeSeries(maSeries); maSeries = null; } return; } if (!maSeries) { maSeries = chart.addLineSeries({ color: 'rgba(255, 204, 0, 1)', lineWidth: 2, crosshairMarkerVisible: false, lastValueVisible: false, priceLineVisible: false, }); } const maData = calculateSMA(currentChartData.slice(-200), MA_PERIOD); maSeries.setData(maData); }
            function preGenerateFullHistory() { for(const symbol in marketData) { let seed = symbol.charCodeAt(0) + symbol.charCodeAt(1); const data = []; let price = { 'EURUSD': 1.0850, 'XAUUSD': 2350.50, 'GBPUSD': 1.2730, 'USDJPY': 157.10 }[symbol]; const isJPY = symbol.includes('JPY'); const pips = isJPY ? 0.01 : 0.0001; const now = Math.floor(new Date('2025-10-14T00:00:00Z').getTime() / 1000); let currentTime = Math.floor((now - (TOTAL_HISTORY_LENGTH * 60)) / 60) * 60; for (let i = 0; i < TOTAL_HISTORY_LENGTH; i++) { const open = price; const close = open + (seededRandom(seed++) - 0.5) * pips * 20; const high = Math.max(open, close) + seededRandom(seed++) * pips * 10; const low = Math.min(open, close) - seededRandom(seed++) * pips * 10; price = close; data.push({ time: currentTime, open, high, low, close }); currentTime += 60; } fullMarketHistory[symbol] = data; } }
            function loadChartData(symbol, intervalInSeconds) { if (!mainSeries) return; const baseData = fullMarketHistory[symbol]; const aggregatedData = []; if (!baseData || baseData.length === 0) return; let lastTimestamp = baseData[0].time; let currentCandle = { ...baseData[0] }; for (let i = 1; i < baseData.length; i++) { const point = baseData[i]; if (point.time >= lastTimestamp + intervalInSeconds) { aggregatedData.push(currentCandle); lastTimestamp = Math.floor(point.time / intervalInSeconds) * intervalInSeconds; currentCandle = { ...point }; } else { currentCandle.high = Math.max(currentCandle.high, point.high); currentCandle.low = Math.min(currentCandle.low, point.low); currentCandle.close = point.close; } } aggregatedData.push(currentCandle); const displayData = aggregatedData.slice(0, 150).map(d => { return currentChartType === 'line' ? {time: d.time, value: d.close} : d; }); currentChartData = aggregatedData; mainSeries.setData(displayData); chart.timeScale().fitContent(); playbackIndex = 150; updateMA(); redrawAllEntryLines(); }
            const formatCurrency = (value) => `$${(value || 0).toFixed(2)}`;
            const formatPrice = (value, symbol) => (value || 0).toFixed(symbol.includes('JPY') ? 2 : 4);
            function renderMarketWatch() { /* ... unchanged ... */ }
            function renderAccountInfo(totalPL) { /* ... unchanged ... */ }
            function renderOpenPositions() { /* ... unchanged ... */ }
            function renderHistory() { /* ... unchanged ... */ }
            function checkSLTP() { /* ... unchanged ... */ }
            function simulateMarket() { playbackIndex++; if (playbackIndex >= TOTAL_HISTORY_LENGTH) { playbackIndex = 150; } for (const symbol in marketData) { const data = marketData[symbol]; const nextCandle = fullMarketHistory[symbol][playbackIndex]; if (!nextCandle) continue; data.lastBid = data.bid; data.bid = nextCandle.close; const pips = symbol.includes('JPY') ? 0.01 : 0.0001; data.ask = data.bid + (pips * (1.5 + seededRandom(playbackIndex + symbol.charCodeAt(0)))); } renderMarketWatch(); renderOpenPositions(); checkSLTP(); if (mainSeries && currentChartData.length > 0) { const selectedSymbol = instrumentSelect.value; const aggregatedHistory = currentChartData; if (playbackIndex < aggregatedHistory.length) { const nextCandle = aggregatedHistory[playbackIndex]; if(nextCandle) { const displayPoint = currentChartType === 'line' ? {time: nextCandle.time, value: nextCandle.close} : nextCandle; mainSeries.update(displayPoint); updateMA(); } } } }
            function drawEntryLine(position) { if (!mainSeries) return null; const { LineStyle } = window.LightweightCharts; return mainSeries.createPriceLine({ price: position.openPrice, color: position.type === 'BUY' ? '#22c55e' : '#ef4444', lineWidth: 1, lineStyle: LineStyle.Dashed, axisLabelVisible: true, title: `${position.type} ${position.volume}`, }); }
            function redrawAllEntryLines() { openPositions.forEach(pos => { if (pos.priceLine && mainSeries) { try { mainSeries.removePriceLine(pos.priceLine); } catch (e) { /* Fails silently if line is already gone */ } pos.priceLine = null; } }); const currentSymbol = instrumentSelect.value; openPositions.forEach(pos => { if (pos.symbol === currentSymbol) { pos.priceLine = drawEntryLine(pos); } }); }
            function openTrade(type) { const symbol = instrumentSelect.value; const volume = parseFloat(lotSizeInput.value); const stopLoss = parseFloat(stopLossInput.value) || 0; const takeProfit = parseFloat(takeProfitInput.value) || 0; if (isNaN(volume) || volume <= 0) { showModal('Invalid Input', 'Please enter a valid lot size.'); return; } const openPrice = type === 'BUY' ? marketData[symbol].ask : marketData[symbol].bid; const requiredMargin = (CONTRACT_SIZES[symbol] * volume * openPrice) / LEVERAGE; const marginUsed = openPositions.reduce((sum, pos) => sum + (CONTRACT_SIZES[pos.symbol] * pos.volume * pos.openPrice) / LEVERAGE, 0); const freeMargin = accountInfo.equity - marginUsed; if (requiredMargin > freeMargin) { showModal('Order Rejected', 'Not enough free margin to open this position.'); return; } if (type === 'BUY') { if (stopLoss > 0 && stopLoss >= openPrice) { showModal('Invalid SL/TP', 'For a BUY order, Stop Loss must be below the open price.'); return; } if (takeProfit > 0 && takeProfit <= openPrice) { showModal('Invalid SL/TP', 'For a BUY order, Take Profit must be above the open price.'); return; } } else { if (stopLoss > 0 && stopLoss <= openPrice) { showModal('Invalid SL/TP', 'For a SELL order, Stop Loss must be above the open price.'); return; } if (takeProfit > 0 && takeProfit >= openPrice) { showModal('Invalid SL/TP', 'For a SELL order, Take Profit must be below the open price.'); return; } } const tradeData = { id: Date.now().toString(), symbol, type, volume, openPrice, stopLoss, takeProfit, openTime: new Date().toJSON() }; if (tradeData.symbol === instrumentSelect.value) { tradeData.priceLine = drawEntryLine(tradeData); } openPositions.push(tradeData); renderOpenPositions(); showModal('Success', `${type} order for ${volume} lot(s) of ${symbol} has been placed.`); stopLossInput.value = ''; takeProfitInput.value = ''; saveState(); }
            function closePosition(positionId, customClosePrice = null) { const posIndex = openPositions.findIndex(p => p.id === positionId); if (posIndex === -1) return; const pos = openPositions[posIndex]; if (pos.priceLine) { mainSeries.removePriceLine(pos.priceLine); } const closePrice = customClosePrice !== null ? customClosePrice : (pos.type === 'BUY' ? marketData[pos.symbol].bid : marketData[pos.symbol].ask); const priceDiff = pos.type === 'BUY' ? (closePrice - pos.openPrice) : (pos.openPrice - closePrice); const pointValue = CONTRACT_SIZES[pos.symbol]; const profit = priceDiff * pos.volume * pointValue; const historyData = { ...pos, closePrice, closeTime: new Date().toJSON(), profit }; delete historyData.priceLine; history.push(historyData); openPositions.splice(posIndex, 1); accountInfo.balance += profit; renderOpenPositions(); renderHistory(); const reason = customClosePrice !== null ? (customClosePrice === pos.takeProfit ? 'Take Profit' : 'Stop Loss') : 'Manual Close'; showModal(`Position Closed (${reason})`, `Position for ${pos.symbol} closed with a profit of ${formatCurrency(profit)}.`); saveState(); }
            buyButton.addEventListener('click', () => openTrade('BUY'));
            sellButton.addEventListener('click', () => openTrade('SELL'));
            openPositionsBody.addEventListener('click', (e) => { if (e.target && e.target.classList.contains('close-btn')) { const positionId = e.target.getAttribute('data-id'); closePosition(positionId); } });
            instrumentSelect.addEventListener('change', (e) => { if (mainSeries) loadChartData(e.target.value, currentInterval); });
            intervalSelector.addEventListener('click', (e) => { if (e.target.classList.contains('control-btn')) { intervalSelector.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); currentInterval = parseInt(e.target.dataset.interval, 10); loadChartData(instrumentSelect.value, currentInterval); } });
            chartTypeSelector.addEventListener('click', (e) => { if (e.target.classList.contains('control-btn')) { chartTypeSelector.querySelector('.active').classList.remove('active'); e.target.classList.add('active'); setChartType(e.target.dataset.type); } });
            maToggle.addEventListener('change', updateMA);
            tabPositions.addEventListener('click', () => { positionsContent.classList.remove('hidden'); historyContent.classList.add('hidden'); tabPositions.classList.add('border-blue-500', 'text-white'); tabPositions.classList.remove('text-gray-400'); tabHistory.classList.remove('border-blue-500', 'text-white'); tabHistory.classList.add('text-gray-400'); });
            tabHistory.addEventListener('click', () => { historyContent.classList.remove('hidden'); positionsContent.classList.add('hidden'); tabHistory.classList.add('border-blue-500', 'text-white'); tabHistory.classList.remove('text-gray-400'); tabPositions.classList.remove('border-blue-500', 'text-white'); tabPositions.classList.add('text-gray-400'); });
            
            // --- App Initialization ---
            function initializeApp() { /* ... unchanged ... */ }
            
            // --- Re-pasting all functions with saveState() calls and minor fixes ---
            function renderMarketWatch() { marketWatchList.innerHTML = ''; for (const symbol in marketData) { const data = marketData[symbol]; const priceChangeClass = data.bid > data.lastBid ? 'price-up' : (data.bid < data.lastBid ? 'price-down' : ''); const pipsMultiplier = symbol.includes('JPY') ? 100 : 10000; const spread = (data.ask - data.bid) * pipsMultiplier; const element = document.createElement('div'); element.className = 'p-2 rounded-md bg-gray-700/50 flex justify-between items-center cursor-pointer hover:bg-gray-600/50'; element.innerHTML = `<div><div class="font-bold">${symbol}</div><div class="text-xs text-gray-400">Spread: ${spread.toFixed(1)}</div></div><div class="text-right font-mono ${priceChangeClass}"><div>${data.bid.toFixed(symbol === 'XAUUSD' || symbol === 'USDJPY' ? 2 : 4)}</div></div>`; element.addEventListener('click', () => { instrumentSelect.value = symbol; instrumentSelect.dispatchEvent(new Event('change')); }); marketWatchList.appendChild(element); } }
            function renderAccountInfo(totalPL) { accountInfo.equity = (accountInfo.balance || 0) + totalPL; balanceValueEl.textContent = formatCurrency(accountInfo.balance); equityValueEl.textContent = formatCurrency(accountInfo.equity); plValueEl.textContent = formatCurrency(totalPL); plValueEl.className = `font-mono font-semibold ${totalPL >= 0 ? 'price-up' : 'price-down'}`; const marginUsed = openPositions.reduce((sum, pos) => sum + (CONTRACT_SIZES[pos.symbol] * pos.volume * pos.openPrice) / LEVERAGE, 0); const freeMargin = accountInfo.equity - marginUsed; const marginLevel = marginUsed > 0 ? (accountInfo.equity / marginUsed) * 100 : 0; marginValueEl.textContent = formatCurrency(marginUsed); freeMarginValueEl.textContent = formatCurrency(freeMargin); marginLevelValueEl.textContent = `${marginLevel.toFixed(2)}%`; }
            function renderOpenPositions() { openPositionsBody.innerHTML = ''; let totalPL = 0; if (openPositions.length === 0) { openPositionsBody.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-gray-500">No open positions.</td></tr>`; renderAccountInfo(0); return; } openPositions.forEach(pos => { const currentPrice = pos.type === 'BUY' ? marketData[pos.symbol].bid : marketData[pos.symbol].ask; const priceDiff = pos.type === 'BUY' ? (currentPrice - pos.openPrice) : (pos.openPrice - currentPrice); const pointValue = CONTRACT_SIZES[pos.symbol]; const profit = priceDiff * pos.volume * pointValue; totalPL += profit; const profitClass = profit >= 0 ? 'price-up' : 'price-down'; const slText = pos.stopLoss > 0 ? formatPrice(pos.stopLoss, pos.symbol) : '-'; const tpText = pos.takeProfit > 0 ? formatPrice(pos.takeProfit, pos.symbol) : '-'; const row = document.createElement('tr'); row.className = 'hover:bg-gray-700/50'; row.innerHTML = `<td class="p-2 font-semibold">${pos.symbol}</td><td class="p-2 font-semibold ${pos.type === 'BUY' ? 'text-green-500' : 'text-red-500'}">${pos.type}</td><td class="p-2">${pos.volume}</td><td class="p-2 font-mono">${formatPrice(pos.openPrice, pos.symbol)}</td><td class="p-2 font-mono text-red-400">${slText}</td><td class="p-2 font-mono text-green-400">${tpText}</td><td class="p-2 font-mono">${formatPrice(currentPrice, pos.symbol)}</td><td class="p-2 font-mono font-semibold ${profitClass}">${formatCurrency(profit)}</td><td class="p-2"><button data-id="${pos.id}" class="close-btn text-xs bg-gray-600 hover:bg-red-600 px-2 py-1 rounded">Close</button></td>`; openPositionsBody.appendChild(row); }); positionsCountEl.textContent = openPositions.length; renderAccountInfo(totalPL); }
            function renderHistory() { historyBody.innerHTML = ''; if (history.length === 0) { historyBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">No trading history.</td></tr>`; } history.sort((a, b) => new Date(b.closeTime) - new Date(a.closeTime)); history.forEach(trade => { const profitClass = trade.profit >= 0 ? 'price-up' : 'price-down'; const row = document.createElement('tr'); row.innerHTML = `<td class="p-2 font-semibold">${trade.symbol}</td><td class="p-2 font-semibold ${trade.type === 'BUY' ? 'text-green-500' : 'text-red-500'}">${trade.type}</td><td class="p-2">${trade.volume}</td><td class="p-2 font-mono">${(trade.openPrice || 0).toFixed(trade.symbol.includes('JPY') ? 2 : 4)}</td><td class="p-2 font-mono">${(trade.closePrice || 0).toFixed(trade.symbol.includes('JPY') ? 2 : 4)}</td><td class="p-2 font-mono font-semibold ${profitClass}">${formatCurrency(trade.profit)}</td>`; historyBody.appendChild(row); }); }
            function checkSLTP() { const positionsToClose = []; for (const pos of openPositions) { const bid = marketData[pos.symbol].bid; const ask = marketData[pos.symbol].ask; if (pos.stopLoss > 0) { if (pos.type === 'BUY' && bid <= pos.stopLoss) { positionsToClose.push({ id: pos.id, closePrice: pos.stopLoss }); } else if (pos.type === 'SELL' && ask >= pos.stopLoss) { positionsToClose.push({ id: pos.id, closePrice: pos.stopLoss }); } } if (pos.takeProfit > 0) { if (pos.type === 'BUY' && bid >= pos.takeProfit) { positionsToClose.push({ id: pos.id, closePrice: pos.takeProfit }); } else if (pos.type === 'SELL' && ask <= pos.takeProfit) { positionsToClose.push({ id: pos.id, closePrice: pos.takeProfit }); } } } positionsToClose.forEach(p => closePosition(p.id, p.closePrice)); }
            function initializeApp() { loadState(); if (!fullMarketHistory || Object.keys(fullMarketHistory).length === 0) { preGenerateFullHistory(); saveState(); } Object.keys(marketData).forEach(symbol => { const historyForSymbol = fullMarketHistory[symbol]; if(historyForSymbol && historyForSymbol.length > 149) { const initialPrice = historyForSymbol[149].close; marketData[symbol].bid = initialPrice; marketData[symbol].ask = initialPrice + (symbol.includes('JPY') ? 0.01 : 0.0001) * 2; } }); renderOpenPositions(); renderHistory(); appContent.classList.remove('hidden'); loadingOverlay.classList.add('hidden'); requestAnimationFrame(() => { try { initChart(); loadChartData(instrumentSelect.value, currentInterval); if (marketIntervalId) clearInterval(marketIntervalId); marketIntervalId = setInterval(simulateMarket, 1500); } catch (e) { console.error("Initialization failed:", e); chartContainer.innerHTML = `<div class="p-4 text-red-400 text-center">Error: Could not load chart.</div>`; } }); }
            
            initializeApp();
        });
    </script>
</body>
</html>

